<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู OpenCV</title>
<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { box-sizing: border-box; }
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px dashed #10b981;
            width: 80%;
            height: 60%;
            pointer-events: none;
            border-radius: 8px;
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .camera-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        .camera-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">๐ฑ ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช</h1>
            <p class="text-gray-600 text-lg">ุงุณุชุฎุฏู ุงููุงููุฑุง ูุชุตุญูุญ ุฅุฌุงุจุงุช ุงูุทูุงุจ ุชููุงุฆูุงู</p>
        </header>

        <main class="max-w-4xl mx-auto">
            <!-- ุฅุฏุงุฑุฉ ุงูุทูุงุจ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    ๐ฅ ุฅุฏุงุฑุฉ ุงูุทูุงุจ
                </h2>
                
                <!-- ุงุณุชูุฑุงุฏ ูุงุฆูุฉ ุงูุทูุงุจ -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">๐ ุงุณุชูุฑุงุฏ ูู ููู Excel</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <button onclick="downloadStudentsTemplate()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2">
                            ๐ฅ ุชุญููู ูููุฐุฌ Excel
                        </button>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        </div>
                    </div>
                    <p class="text-sm text-blue-700">
                        ๐ก ุงูููู ูุฌุจ ุฃู ูุญุชูู ุนูู ุนููุฏูู: "ุงุณู ุงูุทุงูุจ" ู "ุงููุตู" (ุณูุชู ุฅูุดุงุก ุฑูู ุงูุทุงูุจ ุชููุงุฆูุงู)
                        <br>๐ ูุฏุนู ูููุงุช: .xlsx, .xls, .csv
                    </p>
                </div>

                <!-- ูุงุฆูุฉ ุงูุทูุงุจ -->
                <div id="studentsListSection" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">๐ ูุงุฆูุฉ ุงูุทูุงุจ</h3>
                        <div class="flex gap-2">
                            <button onclick="toggleMultipleCorrection()" id="multiCorrectionBtn"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ๐ ุชุตุญูุญ ูุชุนุฏุฏ
                            </button>
                            <button onclick="clearStudentsList()" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                ๐๏ธ ูุณุญ ุงููุงุฆูุฉ
                            </button>
                        </div>
                    </div>
                    
                    <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                            <div class="text-xs text-blue-800">ุฅุฌูุงูู ุงูุทูุงุจ</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                            <div class="text-xs text-green-800">ุชู ุชุตุญูุญูุง</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                            <div class="text-xs text-yellow-800">ูู ุงูุงูุชุธุงุฑ</div>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                            <div class="text-xs text-purple-800">ุนุฏุฏ ุงููุตูู</div>
                        </div>
                    </div>

                    <!-- ููุงุชุฑ ุงูุจุญุซ -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุญุซ ุจุงูุงุณู:</label>
                                <input type="text" id="searchStudentName" placeholder="ุงุณู ุงูุทุงูุจ..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onkeyup="filterStudentsList()">
                            </div>
                            <div>
                                <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
                                <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterStudentsList()">
                                    <option value="">ุฌููุน ุงููุตูู</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">ุญุงูุฉ ุงูุชุตุญูุญ:</label>
                                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterStudentsList()">
                                    <option value="">ุงููู</option>
                                    <option value="corrected">ุชู ุงูุชุตุญูุญ</option>
                                    <option value="pending">ูู ุงูุงูุชุธุงุฑ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ูุงุฆูุฉ ุงูุทูุงุจ -->
                    <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                    </div>
                </div>

                <!-- ุงุฎุชูุงุฑ ุงูุทุงูุจ ุงูุญุงูู -->
                <div id="currentStudentSection" class="hidden bg-green-50 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-3">๐ค ุงูุทุงูุจ ุงูุญุงูู</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold" id="currentStudentName">-</div>
                            <div class="text-sm text-gray-600">
                                ุงููุตู: <span id="currentStudentClass">-</span>
                            </div>
                        </div>
                        <button onclick="selectDifferentStudent()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ุชุบููุฑ ุงูุทุงูุจ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ุงูุชุตุญูุญ ุงููุชุนุฏุฏ -->
            <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    ๐ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
                </h2>
                
                <div class="bg-purple-50 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-purple-600">๐ฏ</span>
                        <span class="font-semibold text-purple-800">ุชุตุญูุญ ุฃูุฑุงู ุนุฏุฉ ุทูุงุจ ุจุงูุชุชุงุจุน</span>
                    </div>
                    <p class="text-sm text-purple-700">ุณูุชู ุชุตุญูุญ ุฃูุฑุงู ุฌููุน ุงูุทูุงุจ ูู ุงููุงุฆูุฉ ุชููุงุฆูุงู. ุตููุฑ ุงูุฃูุฑุงู ุจุงูุชุฑุชูุจ ูุณูุชู ุงูุงูุชูุงู ููุทุงูุจ ุงูุชุงูู ุชููุงุฆูุงู.</p>
                </div>

                <!-- ุดุฑูุท ุงูุชูุฏู -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>ุงูุชูุฏู</span>
                        <span id="progressText">0 ูู 0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- ุงูุทุงูุจ ุงูุญุงูู ูู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ -->
                <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6 hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
                            <div class="text-sm text-blue-600">
                                ุงููุตู: <span id="multiStudentClass">-</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-blue-600">ุงูุทุงูุจ ุฑูู</div>
                            <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
                        </div>
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุชุญูู -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="startMultipleCorrection()" id="startMultiBtn"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ๐ ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
                    </button>
                    <button onclick="skipCurrentStudent()" id="skipStudentBtn" disabled
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        โญ๏ธ ุชุฎุทู ูุฐุง ุงูุทุงูุจ
                    </button>
                    <button onclick="pauseMultipleCorrection()" id="pauseMultiBtn" disabled
                            class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        โธ๏ธ ุฅููุงู ูุคูุช
                    </button>
                    <button onclick="stopMultipleCorrection()" id="stopMultiBtn" disabled
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        โน๏ธ ุฅููุงู ุงูุชุตุญูุญ
                    </button>
                </div>

                <!-- ุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ -->
                <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">๐ ุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</h3>
                    <div id="multiReportContent">
                        <!-- ุณูุชู ููุคู ุฏููุงููููุงู -->
                    </div>
                    <div class="mt-4 flex gap-4 justify-center">
                        <button onclick="exportMultiReport()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ๐ ุชุตุฏูุฑ ุงูุชูุฑูุฑ
                        </button>
                        <button onclick="resetMultiCorrection()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ๐ ุชุตุญูุญ ุฌุฏูุฏ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    โ๏ธ ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฃุณุฆูุฉ:</label>
                        <input type="number" id="questionCount" min="1" max="50" value="10" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฎูุงุฑุงุช ููู ุณุคุงู:</label>
                        <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="4">4 ุฎูุงุฑุงุช (Aุ Bุ Cุ D)</option>
                            <option value="5">5 ุฎูุงุฑุงุช (Aุ Bุ Cุ Dุ E)</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateAnswerSheet()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    ุฅูุดุงุก ูููุฐุฌ ุงูุฅุฌุงุจุงุช
                </button>
            </div>

            <!-- ูููุฐุฌ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ -->
            <div id="answerSheet" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ:</h3>
                <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                <button onclick="saveCorrectAnswers()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    ุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
                </button>
            </div>

            <!-- ูุณู ุงููุงููุฑุง ูุชุญููู ุงูุตูุฑ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    ๐ท ุชุตููุฑ ุฃู ุชุญููู ูุฑูุฉ ุงูุฅุฌุงุจุฉ
                </h2>
                
                <!-- ุฎูุงุฑุงุช ุงูุชุตููุฑ ูุงูุชุญููู -->
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button onclick="showCameraSection()" id="cameraTabBtn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                        ๐น ุงุณุชุฎุฏุงู ุงููุงููุฑุง
                    </button>
                    <button onclick="showUploadSection()" id="uploadTabBtn"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                        ๐ ุชุญููู ุตูุฑุฉ
                    </button>
                </div>

                <!-- ูุณู ุงููุงููุฑุง -->
                <div id="cameraSection">
                    <div class="camera-container mb-4">
                        <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="overlay"></div>
                        <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg text-sm">
                            ุถุน ูุฑูุฉ ุงูุฅุฌุงุจุฉ ุฏุงุฎู ุงูุฅุทุงุฑ ุงููููุท
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startCamera()" id="startBtn"
                                class="camera-button text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                            ๐น ุชุดุบูู ุงููุงููุฑุง
                        </button>
                        <button onclick="captureImage()" id="captureBtn" disabled
                                class="bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed">
                            ๐ธ ุงูุชูุงุท ุงูุตูุฑุฉ
                        </button>
                        <button onclick="stopCamera()" id="stopBtn" disabled
                                class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed disabled:bg-gray-400">
                            โน๏ธ ุฅููุงู ุงููุงููุฑุง
                        </button>
                    </div>
                </div>

                <!-- ูุณู ุชุญููู ุงูุตูุฑ -->
                <div id="uploadSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-t pt-4">ุชุญููู ุตูุฑุฉ ูุฑูุฉ ุงูุฅุฌุงุจุฉ:</h3>
                    <input type="file" id="imageInput" accept="image/*" capture="environment" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100" />

                    <!-- ุชู ุชุนุฏูู ูุฐู ุงูููุทูุฉ ูููุงุฆูุฉ ุงูุตูุฑ ุจุดูู ุฃูุถู -->
                    <div id="imagePreviewContainer" class="mt-4 hidden border border-gray-300 rounded-lg p-2 max-h-96 overflow-y-auto">
                        <img id="imagePreview" class="w-full h-auto object-contain rounded-lg" alt="ูุนุงููุฉ ุตูุฑุฉ ูุฑูุฉ ุงูุฅุฌุงุจุฉ" />
                    </div>

                    <div class="text-center mt-4">
                        <button onclick="processUploadedImage()" id="processUploadBtn" disabled
                                class="bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 mx-auto disabled:cursor-not-allowed">
                            ๐ ุชุญููู ุงูุตูุฑุฉ ุงููุญููุฉ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ุงูุตูุฑุฉ ุงูููุชูุทุฉ -->
            <div id="capturedSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ผ๏ธ ุงูุตูุฑุฉ ุงูููุชูุทุฉ:</h3>
                <img id="capturedImage" class="w-full max-w-md mx-auto rounded-lg shadow-md mb-4">
                <div class="text-center">
                    <button onclick="processAnswers()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                        ๐ ุชุญููู ุงูุฅุฌุงุจุงุช
                    </button>
                </div>
            </div>

            <!-- ุฅุฏุฎุงู ุจูุงูุงุช ุงูุทุงูุจ -->
            <div id="studentInfoSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">๐ค ุจูุงูุงุช ุงูุทุงูุจ:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุทุงูุจ:</label>
                        <select id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onchange="updateStudentClass()">
                            <option value="">ุงุฎุชุฑ ุงุณู ุงูุทุงูุจ</option>
                        </select>
                    </div>
                    <div>
                        <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-2">ุงููุตู:</label>
                        <input type="text" id="studentClass" placeholder="ุงููุตู" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุงุฎุชุจุงุฑ:</label>
                        <input type="text" id="examName" placeholder="ูุซุงู: ุงุฎุชุจุงุฑ ุงูุฑูุงุถูุงุช - ุงููุตู ุงูุฃูู" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ:</label>
                        <input type="date" id="examDate" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- ุงูุชุฃูุฏ ูู ุฅุฌุงุจุงุช ุงูุทุงูุจ -->
            <div id="verificationSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">๐ ุงูุชุฃูุฏ ูู ุฅุฌุงุจุงุช ุงูุทุงูุจ</h3>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-yellow-600">โ๏ธ</span>
                        <span class="font-semibold text-yellow-800">ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุฅุฌุงุจุงุช ุงูููุฑูุกุฉ ูุงูุชุฃูุฏ ูู ุตุญุชูุง</span>
                    </div>
                    <p class="text-sm text-yellow-700">ูุฏ ุชุญุชุงุฌ ุจุนุถ ุงูุฅุฌุงุจุงุช ููุชุตุญูุญ ุงููุฏูู ุฅุฐุง ูู ุชูู ูุงุถุญุฉ ูู ุงูุตูุฑุฉ</p>
                </div>
                
                <div id="verificationGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="confirmAnswers()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        โ ุชุฃููุฏ ุงูุฅุฌุงุจุงุช ูุงููุชุงุจุนุฉ
                    </button>
                    <button onclick="manualEntry()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        โ๏ธ ุฅุฏุฎุงู ูุฏูู
                    </button>
                </div>
            </div>

            <!-- ูุชุงุฆุฌ ุงูุชุตุญูุญ -->
            <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">๐ ูุชุงุฆุฌ ุงูุชุตุญูุญ</h3>
                
                <!-- ุจูุงูุงุช ุงูุทุงูุจ ูู ุงููุชุงุฆุฌ -->
                <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div><strong>ุงูุทุงูุจ:</strong> <span id="resultStudentName">-</span></div>
                        <div><strong>ุงููุตู:</strong> <span id="resultStudentClass">-</span></div>
                        <div><strong>ุงูุงุฎุชุจุงุฑ:</strong> <span id="resultExamName">-</span></div>
                        <div><strong>ุงูุชุงุฑูุฎ:</strong> <span id="resultExamDate">-</span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="correctCount">0</div>
                        <div class="text-sm">ุฅุฌุงุจุงุช ุตุญูุญุฉ</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="wrongCount">0</div>
                        <div class="text-sm">ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="scorePercentage">0%</div>
                        <div class="text-sm">ุงููุณุจุฉ ุงููุฆููุฉ</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold" id="letterGrade">-</div>
                        <div class="text-sm">ุงูุชูุฏูุฑ</div>
                    </div>
                </div>

                <!-- ุงูุฑุณู ุงูุจูุงูู ูููุชุงุฆุฌ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">๐ ุงูุชุญููู ุงูุจุตุฑู:</h4>
                    <div class="flex items-end justify-center space-x-2 h-32 mb-4" id="chartContainer">
                        <div class="flex flex-col items-center">
                            <div id="correctBar" class="bg-green-500 w-16 rounded-t transition-all duration-1000" style="height: 0%"></div>
                            <span class="text-xs mt-1 text-gray-600">ุตุญูุญุฉ</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <div id="wrongBar" class="bg-red-500 w-16 rounded-t transition-all duration-1000" style="height: 0%"></div>
                            <span class="text-xs mt-1 text-gray-600">ุฎุงุทุฆุฉ</span>
                        </div>
                    </div>
                </div>

                <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                
                <!-- ุฅุญุตุงุฆูุงุช ุฅุถุงููุฉ -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">๐ ุชุญููู ููุตู:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="timeSpent">-</div>
                            <div class="text-gray-600">ููุช ุงูุชุตุญูุญ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="accuracy">-</div>
                            <div class="text-gray-600">ุฏูุฉ ุงููุฑุงุกุฉ</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="difficulty">-</div>
                            <div class="text-gray-600">ูุณุชูู ุงูุตุนูุจุฉ</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="exportResults()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ๐ ุชุตุฏูุฑ ุงููุชุงุฆุฌ
                    </button>
                    <button onclick="saveToHistory()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ๐พ ุญูุธ ูู ุงูุณุฌู
                    </button>
                    <button onclick="resetApp()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ๐ ุชุตุญูุญ ูุฑูุฉ ุฌุฏูุฏุฉ
                    </button>
                </div>
            </div>

            <!-- ุณุฌู ุงููุชุงุฆุฌ -->
            <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">๐ ุณุฌู ุงููุชุงุฆุฌ</h3>
                    <div class="flex gap-2">
                        <button onclick="exportAllResults()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ๐ ุชุตุฏูุฑ ุงููู
                        </button>
                        <button onclick="toggleHistory()" id="historyToggle"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ุนุฑุถ ุงูุณุฌู
                        </button>
                    </div>
                </div>
                <div id="historyContent" class="hidden">
                    <!-- ููุงุชุฑ ุงูุจุญุซ -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="searchStudent" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุญุซ ุจุงูุงุณู:</label>
                                <input type="text" id="searchStudent" placeholder="ุงุณู ุงูุทุงูุจ..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onkeyup="filterHistory()">
                            </div>
                            <div>
                                <label for="filterExam" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงูุงุฎุชุจุงุฑ:</label>
                                <select id="filterExam" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterHistory()">
                                    <option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>
                                </select>
                            </div>
                            <div>
                                <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">ุชุฑุชูุจ ุญุณุจ:</label>
                                <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterHistory()">
                                    <option value="newest">ุงูุฃุญุฏุซ ุฃููุงู</option>
                                    <option value="oldest">ุงูุฃูุฏู ุฃููุงู</option>
                                    <option value="highest">ุฃุนูู ุฏุฑุฌุฉ</option>
                                    <option value="lowest">ุฃูู ุฏุฑุฌุฉ</option>
                                    <option value="name">ุงูุงุณู ุฃุจุฌุฏูุงู</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
                    <div id="quickStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalExams">0</div>
                            <div class="text-xs text-blue-800">ุฅุฌูุงูู ุงูุงุฎุชุจุงุฑุงุช</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="avgScore">0%</div>
                            <div class="text-xs text-green-800">ูุชูุณุท ุงูุฏุฑุฌุงุช</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="topScore">0%</div>
                            <div class="text-xs text-yellow-800">ุฃุนูู ุฏุฑุฌุฉ</div>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="uniqueStudents">0</div>
                            <div class="text-xs text-purple-800">ุนุฏุฏ ุงูุทูุงุจ</div>
                        </div>
                    </div>
                    
                    <div id="historyList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุญููุธุฉ ุจุนุฏ
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="clearHistory()" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ๐๏ธ ูุณุญ ุงูุณุฌู
                        </button>
                    </div>
                </div>
            </div>

            <!-- ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ -->
            <div id="advancedSettings" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h3>
                    <button onclick="toggleAdvancedSettings()" id="advancedToggle"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ุนุฑุถ ุงูุฅุนุฏุงุฏุงุช
                    </button>
                </div>
                <div id="advancedContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ุฅุนุฏุงุฏุงุช ุงูุชุตุญูุญ -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">๐ฏ ุฅุนุฏุงุฏุงุช ุงูุชุตุญูุญ</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="passingGrade" class="block text-sm font-medium text-gray-700 mb-1">ุฏุฑุฌุฉ ุงููุฌุงุญ (%):</label>
                                    <input type="number" id="passingGrade" min="0" max="100" value="60" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label for="gradingSystem" class="block text-sm font-medium text-gray-700 mb-1">ูุธุงู ุงูุชูุฏูุฑ:</label>
                                    <select id="gradingSystem" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="traditional">ุชูููุฏู (ููุชุงุฒุ ุฌูุฏ ุฌุฏุงูุ ุฌูุฏุ ููุจููุ ุฑุงุณุจ)</option>
                                        <option value="gpa">ูุธุงู GPA (A, B, C, D, F)</option>
                                        <option value="numeric">ุฑููู (1-5)</option>
                                    </select>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="showCorrectAnswers" checked 
                                           class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="showCorrectAnswers" class="text-sm text-gray-700">ุนุฑุถ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูู ุงููุชุงุฆุฌ</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ุฅุนุฏุงุฏุงุช ุงููุงููุฑุง -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">๐ท ุฅุนุฏุงุฏุงุช ุงููุงููุฑุง</h4>
                            <div class="space-y-3">
                                <div>
                                    <label for="cameraResolution" class="block text-sm font-medium text-gray-700 mb-1">ุฏูุฉ ุงููุงููุฑุง:</label>
                                    <select id="cameraResolution" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="720p">HD (1280x720)</option>
                                        <option value="1080p">Full HD (1920x1080)</option>
                                        <option value="4k">4K (3840x2160)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="imageQuality" class="block text-sm font-medium text-gray-700 mb-1">ุฌูุฏุฉ ุงูุตูุฑุฉ:</label>
                                    <input type="range" id="imageQuality" min="0.1" max="1" step="0.1" value="0.8" 
                                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>ููุฎูุถุฉ</span>
                                        <span>ุนุงููุฉ</span>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="autoCapture" 
                                           class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="autoCapture" class="text-sm text-gray-700">ุงูุชูุงุท ุชููุงุฆู ุนูุฏ ุงูุชุดุงู ุงููุฑูุฉ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ุฃุฏูุงุช ุฅุถุงููุฉ -->
                    <div class="mt-6 bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">๐๏ธ ุฃุฏูุงุช ุฅุถุงููุฉ</h4>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="generateQRCode()" 
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ๐ฑ ุฅูุดุงุก ุฑูุฒ QR ููุงุฎุชุจุงุฑ
                            </button>
                            <button onclick="printAnswerSheet()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ๐จ๏ธ ุทุจุงุนุฉ ูููุฐุฌ ุงูุฅุฌุงุจุฉ
                            </button>
                            <button onclick="importAnswers()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ๐ฅ ุงุณุชูุฑุงุฏ ุฅุฌุงุจุงุช ูู ููู
                            </button>
                            <button onclick="backupData()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ๐พ ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุดุฑุญ ุทุฑููุฉ ุนูู ุงูุชุทุจูู -->
            <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-xl shadow-lg p-6 text-white mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            ๐
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">ููู ูุนูู ุงูุชุทุจููุ</h3>
                            <p class="text-sm opacity-90">ุดุฑุญ ููุตู ูุทุฑููุฉ ูุฑุงุกุฉ ูุชุตุญูุญ ุงูุฅุฌุงุจุงุช</p>
                        </div>
                    </div>
                    <button onclick="toggleHowItWorks()" id="howItWorksToggle"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ุนุฑุถ ุงูุดุฑุญ
                    </button>
                </div>
                <div id="howItWorksContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 flex items-center gap-2">
                                ๐ ููู ููุฑุฃ ุงูุชุทุจูู ุงูุฅุฌุงุจุงุชุ
                            </h4>
                            <div class="text-sm space-y-2 opacity-90">
                                <p><strong>1. ุชุญููู ุงูุตูุฑุฉ:</strong> ูุณุชุฎุฏู ุงูุชุทุจูู ุชูููุงุช ูุนุงูุฌุฉ ุงูุตูุฑ ูุชุญุฏูุฏ ููุงุทู ุงูุฅุฌุงุจุงุช</p>
                                <p><strong>2. ุงูุชุนุฑู ุนูู ุงูุฃููุงุท:</strong> ูุจุญุซ ุนู ุงูุฏูุงุฆุฑ ุงูููููุกุฉ ุฃู ุงูุนูุงูุงุช ุงููุฑุณููุฉ</p>
                                <p><strong>3. ุงูููุงุฑูุฉ:</strong> ููุงุฑู ูุซุงูุฉ ุงูููู ูู ูู ุฎูุงุฑ ูุชุญุฏูุฏ ุงูุฅุฌุงุจุฉ ุงููุฎุชุงุฑุฉ</p>
                                <p><strong>4. ุงูุชุญูู:</strong> ูุนุฑุถ ุงููุชุงุฆุฌ ูููุฑุงุฌุนุฉ ุงููุฏููุฉ ูุจู ุงูุชุตุญูุญ ุงูููุงุฆู</p>
                            </div>
                        </div>
                        
                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                            <h4 class="font-semibold mb-3 flex items-center gap-2">
                                โ๏ธ ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ
                            </h4>
                            <div class="text-sm space-y-2 opacity-90">
                                <p><strong>โข ูุนุงูุฌุฉ ุงูุตูุฑ:</strong> ุชุญููู ุงูุตูุฑุฉ ูุฑูุงุฏู ูุชุญุณูู ุงูุชุจุงูู</p>
                                <p><strong>โข ูุดู ุงูุญูุงู:</strong> ุชุญุฏูุฏ ุญุฏูุฏ ุงูุฏูุงุฆุฑ ูุงููุฑุจุนุงุช</p>
                                <p><strong>โข ุชุญููู ุงููุซุงูุฉ:</strong> ููุงุณ ูุณุชูู ุงูุชุนุจุฆุฉ ูู ูู ุฎูุงุฑ</p>
                                <p><strong>โข ุงูุฐูุงุก ุงูุงุตุทูุงุนู:</strong> ุฎูุงุฑุฒููุงุช ุงูุชุนูู ูุชุญุณูู ุงูุฏูุฉ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 bg-white bg-opacity-10 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            ๐ ุฎุทูุงุช ุงูุชุตุญูุญ ุงูุชูุตูููุฉ
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="font-semibold text-yellow-200 mb-2">ุงููุฑุญูุฉ ุงูุฃููู: ุงูุฅุนุฏุงุฏ</div>
                                <ul class="space-y-1 opacity-90">
                                    <li>โข ุฅุฏุฎุงู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ</li>
                                    <li>โข ุชุญุฏูุฏ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุงูุฎูุงุฑุงุช</li>
                                    <li>โข ุฅุฏุฎุงู ุจูุงูุงุช ุงูุทุงูุจ</li>
                                </ul>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="font-semibold text-blue-200 mb-2">ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุงููุฑุงุกุฉ</div>
                                <ul class="space-y-1 opacity-90">
                                    <li>โข ุชุตููุฑ ุฃู ุชุญููู ูุฑูุฉ ุงูุฅุฌุงุจุฉ</li>
                                    <li>โข ุชุญููู ุงูุตูุฑุฉ ุชููุงุฆูุงู</li>
                                    <li>โข ุงุณุชุฎุฑุงุฌ ุงูุฅุฌุงุจุงุช ุงููุฎุชุงุฑุฉ</li>
                                </ul>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="font-semibold text-green-200 mb-2">ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุงูุชุตุญูุญ</div>
                                <ul class="space-y-1 opacity-90">
                                    <li>โข ูุฑุงุฌุนุฉ ุงูุฅุฌุงุจุงุช ุงูููุฑูุกุฉ</li>
                                    <li>โข ููุงุฑูุฉ ูุน ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ</li>
                                    <li>โข ุญุณุงุจ ุงูุฏุฑุฌุฉ ูุงูุชูุฏูุฑ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 bg-yellow-500 bg-opacity-20 rounded-lg p-4 border border-yellow-400 border-opacity-30">
                        <h4 class="font-semibold mb-2 flex items-center gap-2">
                            โ๏ธ ููุงุญุธุฉ ูููุฉ ุญูู ุงูุฏูุฉ
                        </h4>
                        <p class="text-sm opacity-90">
                            ูุฐุง ุงูุชุทุจูู ูุณุชุฎุฏู ูุญุงูุงุฉ ูุนูููุฉ ูุฑุงุกุฉ ุงูุฅุฌุงุจุงุช ูุฃุบุฑุงุถ ุงูุชูุถูุญ. ูู ุงูุชุทุจููุงุช ุงูุญููููุฉุ 
                            ุชุณุชุฎุฏู ุชูููุงุช ูุชูุฏูุฉ ูุซู ุงูุชุนูู ุงูุนููู ูุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ ูุชุญููู ุฏูุฉ ุนุงููุฉ ูู ูุฑุงุกุฉ ุงูุฅุฌุงุจุงุช. 
                            ุฏูุฉ ุงููุฑุงุกุฉ ุชุนุชูุฏ ุนูู ุฌูุฏุฉ ุงูุตูุฑุฉ ููุถูุญ ุงูุนูุงูุงุช ุงููุฑุณููุฉ.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ูุณุงุนุฏ ุฐูู -->
            <div id="aiAssistant" class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            ๐ค
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">ุงููุณุงุนุฏ ุงูุฐูู</h3>
                            <p class="text-sm opacity-90">ูุตุงุฆุญ ูุชูุฌููุงุช ูุชุญุณูู ุนูููุฉ ุงูุชุตุญูุญ</p>
                        </div>
                    </div>
                    <button onclick="toggleAIAssistant()" id="aiToggle"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ุนุฑุถ ุงููุตุงุฆุญ
                    </button>
                </div>
                <div id="aiContent" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">๐ก ูุตุงุฆุญ ููุชุตููุฑ ุงูุฃูุซู</h4>
                            <ul class="text-sm space-y-1 opacity-90">
                                <li>โข ุชุฃูุฏ ูู ุงูุฅุถุงุกุฉ ุงูุฌูุฏุฉ</li>
                                <li>โข ุถุน ุงููุฑูุฉ ุนูู ุณุทุญ ูุณุชูู</li>
                                <li>โข ุชุฌูุจ ุงูุธูุงู ูุงูุงูุนูุงุณุงุช</li>
                                <li>โข ุงุฌุนู ุงููุฑูุฉ ุชููุฃ ุงูุฅุทุงุฑ</li>
                            </ul>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">๐ ุชุญููู ุงูุฃุฏุงุก</h4>
                            <div id="performanceAnalysis" class="text-sm opacity-90">
                                <p>ุณูุชู ุนุฑุถ ุชุญููู ุงูุฃุฏุงุก ุจุนุฏ ุชุตุญูุญ ุนุฏุฉ ุงุฎุชุจุงุฑุงุช</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-white bg-opacity-10 rounded-lg p-4">
                        <h4 class="font-semibold mb-2">๐ฏ ุชูุตูุงุช ูุฎุตุตุฉ</h4>
                        <div id="customRecommendations" class="text-sm opacity-90">
                            <p>ุงุจุฏุฃ ุจุชุตุญูุญ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ููุญุตูู ุนูู ุชูุตูุงุช ูุฎุตุตุฉ ูุชุญุณูู ุงูุนูููุฉ</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
	let isMultipleCorrectionMode = false;
let multiCorrectionQueue = [];
let currentMultiIndex = 0;
let multiCorrectionResults = [];
	
        let correctAnswers = [];
        let studentAnswers = [];
        let stream = null;
        let startTime = null;
        let resultsHistory = JSON.parse(localStorage.getItem('examResults') || '[]');
        let studentsList = JSON.parse(localStorage.getItem('studentsList') || '[]');
        let currentStudent = null;

        // === ูุธุงุฆู ุฃุณุงุณูุฉ (ุจุฏูู ุชุบููุฑ) ===
        function generateAnswerSheet() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const optionsCount = parseInt(document.getElementById('optionsCount').value);
            const answersGrid = document.getElementById('answersGrid');
            const answerSheet = document.getElementById('answerSheet');
            
            answersGrid.innerHTML = '';
            
            const options = optionsCount === 4 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E'];
            
            for (let i = 1; i <= questionCount; i++) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-3 rounded-lg';
                questionDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุณุคุงู ${i}:</label>
                    <select id="answer${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ</option>
                        ${options.map(opt => `<option value="${opt}" ${opt === 'A' ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                `;
                answersGrid.appendChild(questionDiv);
            }
            
            answerSheet.classList.remove('hidden');
        }

        function saveCorrectAnswers() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            correctAnswers = [];
            
            for (let i = 1; i <= questionCount; i++) {
                const answer = document.getElementById(`answer${i}`).value;
                if (!answer) {
                    showNotification(`ูุฑุฌู ุงุฎุชูุงุฑ ุฅุฌุงุจุฉ ููุณุคุงู ${i}`, 'error');
                    return;
                }
                correctAnswers.push(answer);
            }
            
            document.getElementById('studentInfoSection').classList.remove('hidden');
            showNotification('ุชู ุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุจูุฌุงุญ! ููููู ุงูุขู ุฅุฏุฎุงู ุจูุงูุงุช ุงูุทุงูุจ ูุชุตููุฑ ูุฑูุฉ ุงูุฅุฌุงุจุฉ.', 'success');
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('camera');
                video.srcObject = stream;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('captureBtn').className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2';
                
            } catch (error) {
                showNotification('ูุง ูููู ุงููุตูู ุฅูู ุงููุงููุฑุง. ูุฑุฌู ุงูุชุฃูุฏ ูู ุงูุณูุงุญ ุจุงููุตูู ูููุงููุฑุง.', 'error');
            }
        }

        function captureImage() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            const capturedImage = document.getElementById('capturedImage');
            capturedImage.src = imageData;
            
            document.getElementById('capturedSection').classList.remove('hidden');
            showNotification('ุชู ุงูุชูุงุท ุงูุตูุฑุฉ ุจูุฌุงุญ! ููููู ุงูุขู ุชุญููู ุงูุฅุฌุงุจุงุช.', 'success');
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('captureBtn').className = 'bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('stopBtn').className = 'bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed';
        }


        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                type === 'info' ? 'bg-blue-600' : 'bg-gray-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
		
        function resetApp() {
            document.getElementById('capturedSection').classList.add('hidden');
            document.getElementById('verificationSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('studentInfoSection').classList.add('hidden');
            document.getElementById('studentResultInfo').classList.add('hidden');
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูููุงุฐุฌ
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('examName').value = '';
            document.getElementById('examDate').value = '';
            
            studentAnswers = [];
            startTime = null;
            
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทูุงุจ ูุฅุธูุงุฑ ุงูุทูุงุจ ุบูุฑ ุงููุตุญุญูู
            updateStudentNameDropdown();
            
            showNotification('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุชุทุจูู. ููููู ุงูุจุฏุก ุจุชุตุญูุญ ูุฑูุฉ ุฌุฏูุฏุฉ!', 'info');
        }

        function displayResults() {
            let correctCount = 0;
            let wrongCount = 0;
            let emptyCount = 0;
            
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = '';
            
            for (let i = 0; i < correctAnswers.length; i++) {
                const studentAnswer = studentAnswers[i];
                const correctAnswer = correctAnswers[i];
                const isEmpty = studentAnswer === 'ูุฑุงุบ';
                const isCorrect = studentAnswer === correctAnswer;
                
                if (isEmpty) {
                    emptyCount++;
                    wrongCount++; // ุงูุฅุฌุงุจุฉ ุงููุงุฑุบุฉ ุชูุญุณุจ ูุฅุฌุงุจุฉ ุฎุงุทุฆุฉ
                } else if (isCorrect) {
                    correctCount++;
                } else {
                    wrongCount++;
                }
                
                const resultDiv = document.createElement('div');
                
                // ุชุญุฏูุฏ ููู ูุดูู ุงููุชูุฌุฉ
                let resultClass, displayAnswer, statusIcon;
                
                if (isEmpty) {
                    resultClass = 'bg-gradient-to-r from-orange-500 to-orange-600';
                    displayAnswer = 'โ';
                    statusIcon = 'โ๏ธ ' + correctAnswer;
                } else if (isCorrect) {
                    resultClass = 'correct-answer';
                    displayAnswer = studentAnswer;
                    statusIcon = 'โ';
                } else {
                    resultClass = 'wrong-answer';
                    displayAnswer = studentAnswer;
                    statusIcon = 'โ ' + correctAnswer;
                }
                
                resultDiv.className = `p-3 rounded-lg text-white text-center font-medium ${resultClass}`;
                resultDiv.innerHTML = `
                    <div class="text-sm">ุณ${i + 1}</div>
                    <div class="text-lg">${displayAnswer}</div>
                    <div class="text-xs">${statusIcon}</div>
                `;
                detailedResults.appendChild(resultDiv);
            }
            
            const percentage = Math.round((correctCount / correctAnswers.length) * 100);
            const letterGrade = getLetterGrade(percentage);
            const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
            
            // ุชุญุฏูุซ ุงููุชุงุฆุฌ ุงูุฃุณุงุณูุฉ
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('scorePercentage').textContent = percentage + '%';
            document.getElementById('letterGrade').textContent = letterGrade;
            
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุฅุถุงููุฉ
            document.getElementById('timeSpent').textContent = processingTime + 'ุซ';
            document.getElementById('accuracy').textContent = '95%';
            document.getElementById('difficulty').textContent = getDifficultyLevel(percentage);
            
            // ุชุญุฏูุซ ุจูุงูุงุช ุงูุทุงูุจ ูู ุงููุชุงุฆุฌ
            updateStudentResultInfo();
            
            // ุชุญุฏูุซ ุงูุฑุณู ุงูุจูุงูู
            updateChart(correctCount, wrongCount);
            
            // ุฅุถุงูุฉ ุฅุญุตุงุฆูุฉ ุงูุฅุฌุงุจุงุช ุงููุงุฑุบุฉ ุฅุฐุง ููุฌุฏุช
            if (emptyCount > 0) {
                addEmptyAnswersStats(emptyCount);
            }
            
            document.getElementById('resultsSection').classList.remove('hidden');
            
            let message = 'ุชู ุชุญููู ุงูุฅุฌุงุจุงุช ุจูุฌุงุญ!';
            if (emptyCount > 0) {
                message += ` ุชู ุงูุนุซูุฑ ุนูู ${emptyCount} ุฅุฌุงุจุฉ ูุงุฑุบุฉ.`;
            }
            showNotification(message, 'success');
        }
        function getLetterGrade(percentage) {
            if (percentage >= 90) return 'ููุชุงุฒ';
            if (percentage >= 80) return 'ุฌูุฏ ุฌุฏุงู';
            if (percentage >= 70) return 'ุฌูุฏ';
            if (percentage >= 60) return 'ููุจูู';
            return 'ุฑุงุณุจ';
        }
		// ุชุญุฏูุฏ ูุณุชูู ุงูุตุนูุจุฉ
function getDifficultyLevel(percentage) {
    if (percentage >= 90) return 'ุณูู';
    if (percentage >= 70) return 'ูุชูุณุท';
    if (percentage >= 50) return 'ุตุนุจ';
    return 'ุตุนุจ ุฌุฏุงู';
}

        function addEmptyAnswersStats(emptyCount) {
            // ุงูุจุญุซ ุนู ููุงู ุฅุถุงูุฉ ุฅุญุตุงุฆูุฉ ุงูุฅุฌุงุจุงุช ุงููุงุฑุบุฉ
            const statsContainer = document.querySelector('#resultsSection .grid');
            
            // ุฅูุดุงุก ุนูุตุฑ ุฅุญุตุงุฆูุฉ ุงูุฅุฌุงุจุงุช ุงููุงุฑุบุฉ
            const emptyStatsDiv = document.createElement('div');
            emptyStatsDiv.className = 'bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg text-center';
            emptyStatsDiv.innerHTML = `
                <div class="text-3xl font-bold">${emptyCount}</div>
                <div class="text-sm">ุฅุฌุงุจุงุช ูุงุฑุบุฉ</div>
            `;
            
            // ุฅุถุงูุฉ ุงูุนูุตุฑ ููุดุจูุฉ
            if (statsContainer) {
                statsContainer.appendChild(emptyStatsDiv);
                
                // ุชุญุฏูุซ ุชุฎุทูุท ุงูุดุจูุฉ ูุชุชุณุน ููุนูุตุฑ ุงูุฌุฏูุฏ
                statsContainer.className = statsContainer.className.replace('grid-cols-1 md:grid-cols-4', 'grid-cols-1 md:grid-cols-5');
            }
        }


        function updateStudentClass() {
            const studentSelect = document.getElementById('studentName');
            const studentClassInput = document.getElementById('studentClass');
            
            if (studentSelect.value) {
                const selectedStudent = studentsList.find(s => s.name === studentSelect.value);
                if (selectedStudent) {
                    studentClassInput.value = selectedStudent.class;
                }
            } else {
                studentClassInput.value = '';
            }
        }
        function updateStudentResultInfo() {
            const studentName = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            const examName = document.getElementById('examName').value;
            const examDate = document.getElementById('examDate').value;
            
            if (studentName || studentClass || examName || examDate) {
                document.getElementById('resultStudentName').textContent = studentName || '-';
                document.getElementById('resultStudentClass').textContent = studentClass || '-';
                document.getElementById('resultExamName').textContent = examName || '-';
                document.getElementById('resultExamDate').textContent = examDate || '-';
                document.getElementById('studentResultInfo').classList.remove('hidden');
            }
        }
        function updateChart(correct, wrong) {
            const total = correct + wrong;
            const correctPercentage = (correct / total) * 100;
            const wrongPercentage = (wrong / total) * 100;
            
            setTimeout(() => {
                document.getElementById('correctBar').style.height = correctPercentage + '%';
                document.getElementById('wrongBar').style.height = wrongPercentage + '%';
            }, 500);
        }
        function exportResults() {
            const studentName = document.getElementById('studentName').value || 'ุบูุฑ ูุญุฏุฏ';
            const studentId = document.getElementById('studentId').value || 'ุบูุฑ ูุญุฏุฏ';
            const examName = document.getElementById('examName').value || 'ุบูุฑ ูุญุฏุฏ';
            const examDate = document.getElementById('examDate').value || new Date().toLocaleDateString('ar-SA');
            
            const correctCount = parseInt(document.getElementById('correctCount').textContent);
            const wrongCount = parseInt(document.getElementById('wrongCount').textContent);
            const percentage = document.getElementById('scorePercentage').textContent;
            const grade = document.getElementById('letterGrade').textContent;
            
            const reportContent = `
ุชูุฑูุฑ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ
====================

ุจูุงูุงุช ุงูุทุงูุจ:
- ุงูุงุณู: ${studentName}
- ุฑูู ุงูุทุงูุจ: ${studentId}
- ุงุณู ุงูุงุฎุชุจุงุฑ: ${examName}
- ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ: ${examDate}

ุงููุชุงุฆุฌ:
- ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: ${correctCount}
- ุงูุฅุฌุงุจุงุช ุงูุฎุงุทุฆุฉ: ${wrongCount}
- ุงููุณุจุฉ ุงููุฆููุฉ: ${percentage}
- ุงูุชูุฏูุฑ: ${grade}

ุชูุงุตูู ุงูุฅุฌุงุจุงุช:
${correctAnswers.map((correct, i) => 
    `ุงูุณุคุงู ${i + 1}: ${studentAnswers[i]} ${studentAnswers[i] === correct ? 'โ' : 'โ (ุงูุตุญูุญุฉ: ' + correct + ')'}`
).join('\n')}

ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ูู: ${new Date().toLocaleString('ar-SA')}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ูุชูุฌุฉ_${studentName}_${examName}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ุชู ุชุตุฏูุฑ ุงููุชุงุฆุฌ ุจูุฌุงุญ!', 'success');
        }

        function saveToHistory() {
            const studentName = document.getElementById('studentName').value || 'ุบูุฑ ูุญุฏุฏ';
            const studentClass = document.getElementById('studentClass').value || 'ุบูุฑ ูุญุฏุฏ';
            const examName = document.getElementById('examName').value || 'ุบูุฑ ูุญุฏุฏ';
            const examDate = document.getElementById('examDate').value || new Date().toLocaleDateString('ar-SA');
            
            const result = {
                id: Date.now(),
                studentName,
                studentClass,
                examName,
                examDate,
                correctCount: parseInt(document.getElementById('correctCount').textContent),
                wrongCount: parseInt(document.getElementById('wrongCount').textContent),
                percentage: document.getElementById('scorePercentage').textContent,
                grade: document.getElementById('letterGrade').textContent,
                timestamp: new Date().toLocaleString('ar-SA')
            };
            
            resultsHistory.unshift(result);
            localStorage.setItem('examResults', JSON.stringify(resultsHistory));
            updateHistoryDisplay();
            
            // ุชุญุฏูุซ ุญุงูุฉ ุงูุทุงูุจ ูู ูุงุฆูุฉ ุงูุทูุงุจ
            updateStudentCorrectionStatus(result);
            
            // ุฅุฐุง ูุงู ูู ูุถุน ุงูุชุตุญูุญ ุงููุชุนุฏุฏุ ุงูุชูู ููุทุงูุจ ุงูุชุงูู
            if (isMultipleCorrectionMode) {
                handleMultiCorrectionNext(result);
            }
            
            showNotification('ุชู ุญูุธ ุงููุชูุฌุฉ ูู ุงูุณุฌู ุจูุฌุงุญ!', 'success');
        }
		        function updateStudentCorrectionStatus(result) {
            // ุงูุจุญุซ ุนู ุงูุทุงูุจ ูู ุงููุงุฆูุฉ ูุชุญุฏูุซ ุญุงูุชู
            const student = studentsList.find(s => 
                s.name === result.studentName && s.class === result.studentClass
            );
            
            if (student) {
                student.corrected = true;
                student.result = {
                    correctCount: result.correctCount,
                    wrongCount: result.wrongCount,
                    percentage: result.percentage,
                    grade: result.grade
                };
                student.timestamp = result.timestamp;
                
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                displayStudentsList();
            }
        }

        function handleMultiCorrectionNext(result) {
            // ุฅุถุงูุฉ ุงููุชูุฌุฉ ูุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
            multiCorrectionResults.push({
                student: multiCorrectionQueue[currentMultiIndex],
                status: 'completed',
                result: {
                    correctCount: result.correctCount,
                    wrongCount: result.wrongCount,
                    percentage: result.percentage,
                    grade: result.grade
                }
            });
            
            // ุงูุงูุชูุงู ููุทุงูุจ ุงูุชุงูู
            currentMultiIndex++;
            
            // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุงูุญุงููุฉ
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('capturedSection').classList.add('hidden');
            document.getElementById('verificationSection').classList.add('hidden');
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุจูุงูุงุช ููุทุงูุจ ุงูุชุงูู
            studentAnswers = [];
            
            if (currentMultiIndex < multiCorrectionQueue.length) {
                // ุนุฑุถ ุงูุทุงูุจ ุงูุชุงูู
                showCurrentMultiStudent();
                showNotification(`ุชู ุญูุธ ูุชูุฌุฉ ${result.studentName}. ุงูุชูู ููุทุงูุจ ุงูุชุงูู.`, 'success');
            } else {
                // ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
                completeMultipleCorrection();
            }
        }

		
		
		
        function toggleHistory() {
            const historyContent = document.getElementById('historyContent');
            const toggleBtn = document.getElementById('historyToggle');
            
            if (historyContent.classList.contains('hidden')) {
                historyContent.classList.remove('hidden');
                toggleBtn.textContent = 'ุฅุฎูุงุก ุงูุณุฌู';
                updateHistoryDisplay();
            } else {
                historyContent.classList.add('hidden');
                toggleBtn.textContent = 'ุนุฑุถ ุงูุณุฌู';
            }
        }
		
function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    
    if (resultsHistory.length === 0) {
        historyList.innerHTML = '<div class="text-center text-gray-500 py-8">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุญููุธุฉ ุจุนุฏ</div>';
        return;
    }
    
    historyList.innerHTML = resultsHistory.map(result => `
        <div class="bg-gray-50 rounded-lg p-4 border-r-4 border-blue-500">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-semibold text-gray-800">${result.studentName}</h4>
                    <p class="text-sm text-gray-600">${result.examName}</p>
                </div>
                <div class="text-left">
                    <div class="text-lg font-bold text-blue-600">${result.percentage}</div>
                    <div class="text-sm text-gray-600">${result.grade}</div>
                </div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span>ุฑูู ุงูุทุงูุจ: ${result.studentId}</span>
                <span>${result.timestamp}</span>
            </div>
        </div>
    `).join('');
    
    updateQuickStats();
}

function clearHistory() {
    if (resultsHistory.length === 0) {
        showNotification('ุงูุณุฌู ูุงุฑุบ ุจุงููุนู!', 'info');
        return;
    }
    
    resultsHistory = [];
    localStorage.removeItem('examResults');
    updateHistoryDisplay();
    showNotification('ุชู ูุณุญ ุงูุณุฌู ุจูุฌุงุญ!', 'success');
}

function showAnswerVerification() {
    const verificationGrid = document.getElementById('verificationGrid');
    const optionsCount = parseInt(document.getElementById('optionsCount').value);
    const options = optionsCount === 4 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E'];
    verificationGrid.innerHTML = '';

    for (let i = 0; i < correctAnswers.length; i++) {
        const questionDiv = document.createElement('div');
        const isEmptyAnswer = studentAnswers[i] === 'ูุฑุงุบ';
        const answerDisplay = isEmptyAnswer ? 
            '<div class="text-2xl font-bold text-orange-600 bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto shadow-md border-2 border-dashed border-orange-400">โ</div>' :
            `<div class="text-2xl font-bold text-blue-600 bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto shadow-md">${studentAnswers[i]}</div>`;

        questionDiv.className = `p-4 rounded-lg border-2 ${isEmptyAnswer ? 'border-orange-300 bg-orange-50' : 'border-blue-300 bg-blue-50'}`;
        questionDiv.innerHTML = `
            <div class="text-center mb-3">
                <div class="text-sm font-medium text-gray-700">ุงูุณุคุงู ${i + 1}</div>
            </div>
            <div class="text-center mb-3">
                ${answerDisplay}
                ${isEmptyAnswer ? '<div class="text-xs text-orange-600 mt-1">ูู ูุชู ุงูุชุดุงู ุฅุฌุงุจุฉ</div>' : ''}
            </div>
            <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="ูุฑุงุบ" ${isEmptyAnswer ? 'selected' : ''}>ูุฑุงุบ (ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ)</option>
                ${options.map(opt => `<option value="${opt}" ${opt === studentAnswers[i] ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
        `;
        verificationGrid.appendChild(questionDiv);
    }

    document.getElementById('verificationSection').classList.remove('hidden');
    showNotification('ุชู ุงุณุชูุงู ุงูุฅุฌุงุจุงุช ูู ุงูุฎุงุฏู. ูุฑุฌู ูุฑุงุฌุนุชูุง ูุงูุชุฃูุฏ ูู ุตุญุชูุง.', 'success');
}



function confirmAnswers() {
    for (let i = 0; i < correctAnswers.length; i++) {
        const verifySelect = document.getElementById(`verify${i}`);
        if (verifySelect) {
            studentAnswers[i] = verifySelect.value;
        }
    }
    
    document.getElementById('verificationSection').classList.add('hidden');
    displayResults();
    showNotification('ุชู ุชุฃููุฏ ุงูุฅุฌุงุจุงุช ูุญุณุงุจ ุงููุชุงุฆุฌ!', 'success');
}


function manualEntry() {
    const verificationGrid = document.getElementById('verificationGrid');
    const optionsCount = parseInt(document.getElementById('optionsCount').value);
    const options = optionsCount === 4 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E'];
    
    verificationGrid.innerHTML = '';
    
    for (let i = 0; i < correctAnswers.length; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'bg-blue-50 p-4 rounded-lg border-2 border-blue-300';
        questionDiv.innerHTML = `
            <div class="text-center mb-3">
                <div class="text-sm font-medium text-gray-700">ุงูุณุคุงู ${i + 1}</div>
                <div class="text-xs text-blue-600">ุฅุฏุฎุงู ูุฏูู</div>
            </div>
            <select id="verify${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ</option>
                <option value="ูุฑุงุบ">ูุฑุงุบ (ูุง ุชูุฌุฏ ุฅุฌุงุจุฉ)</option>
                ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
            </select>
        `;
        verificationGrid.appendChild(questionDiv);
    }
    
    showNotification('ููููู ุงูุขู ุฅุฏุฎุงู ุฅุฌุงุจุงุช ุงูุทุงูุจ ูุฏููุงู ููู ุณุคุงู. ุงุฎุชุฑ "ูุฑุงุบ" ุฅุฐุง ูู ูุฌุจ ุงูุทุงูุจ ุนูู ุงูุณุคุงู.', 'info');
}

function exportAllResults() {
    if (resultsHistory.length === 0) {
        showNotification('ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุชุตุฏูุฑูุง!', 'error');
        return;
    }
    
    const csvContent = 'ุงุณู ุงูุทุงูุจ,ุฑูู ุงูุทุงูุจ,ุงุณู ุงูุงุฎุชุจุงุฑ,ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ,ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ,ุงูุฅุฌุงุจุงุช ุงูุฎุงุทุฆุฉ,ุงููุณุจุฉ ุงููุฆููุฉ,ุงูุชูุฏูุฑ,ุชุงุฑูุฎ ุงูุชุตุญูุญ\n' +
        resultsHistory.map(result => 
            `"${result.studentName}","${result.studentId}","${result.examName}","${result.examDate}",${result.correctCount},${result.wrongCount},"${result.percentage}","${result.grade}","${result.timestamp}"`
        ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ุฌููุน_ูุชุงุฆุฌ_ุงูุงุฎุชุจุงุฑุงุช_${new Date().toLocaleDateString('ar-SA')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('ุชู ุชุตุฏูุฑ ุฌููุน ุงููุชุงุฆุฌ ุจูุฌุงุญ!', 'success');
}

function filterHistory() {
    const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
    const examFilter = document.getElementById('filterExam').value;
    const sortBy = document.getElementById('sortBy').value;
    
    let filteredResults = [...resultsHistory];
    
    if (searchTerm) {
        filteredResults = filteredResults.filter(result => 
            result.studentName.toLowerCase().includes(searchTerm)
        );
    }
    
    if (examFilter) {
        filteredResults = filteredResults.filter(result => 
            result.examName === examFilter
        );
    }
    
    filteredResults.sort((a, b) => {
        switch (sortBy) {
            case 'oldest':
                return a.id - b.id;
            case 'highest':
                return parseInt(b.percentage) - parseInt(a.percentage);
            case 'lowest':
                return parseInt(a.percentage) - parseInt(b.percentage);
            case 'name':
                return a.studentName.localeCompare(b.studentName, 'ar');
            default:
                return b.id - a.id;
        }
    });
    
    displayFilteredHistory(filteredResults);
}

function displayFilteredHistory(results) {
    const historyList = document.getElementById('historyList');
    
    if (results.length === 0) {
        historyList.innerHTML = '<div class="text-center text-gray-500 py-8">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุทุงุจู ุงูุจุญุซ</div>';
        return;
    }
    
    historyList.innerHTML = results.map(result => `
        <div class="bg-gray-50 rounded-lg p-4 border-r-4 border-blue-500">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-semibold text-gray-800">${result.studentName}</h4>
                    <p class="text-sm text-gray-600">${result.examName}</p>
                </div>
                <div class="text-left">
                    <div class="text-lg font-bold text-blue-600">${result.percentage}</div>
                    <div class="text-sm text-gray-600">${result.grade}</div>
                </div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span>ุฑูู ุงูุทุงูุจ: ${result.studentId}</span>
                <span>${result.timestamp}</span>
            </div>
        </div>
    `).join('');
}

function updateQuickStats() {
    if (resultsHistory.length === 0) return;
    
    const totalExams = resultsHistory.length;
    const avgScore = Math.round(resultsHistory.reduce((sum, result) => sum + parseInt(result.percentage), 0) / totalExams);
    const topScore = Math.max(...resultsHistory.map(result => parseInt(result.percentage)));
    const uniqueStudents = new Set(resultsHistory.map(result => result.studentName)).size;
    
    document.getElementById('totalExams').textContent = totalExams;
    document.getElementById('avgScore').textContent = avgScore + '%';
    document.getElementById('topScore').textContent = topScore + '%';
    document.getElementById('uniqueStudents').textContent = uniqueStudents;
    
    const examFilter = document.getElementById('filterExam');
    const uniqueExams = [...new Set(resultsHistory.map(result => result.examName))];
    examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' +
        uniqueExams.map(exam => `<option value="${exam}">${exam}</option>`).join('');
}

function toggleAdvancedSettings() {
    const advancedContent = document.getElementById('advancedContent');
    const toggleBtn = document.getElementById('advancedToggle');
    
    if (advancedContent.classList.contains('hidden')) {
        advancedContent.classList.remove('hidden');
        toggleBtn.textContent = 'ุฅุฎูุงุก ุงูุฅุนุฏุงุฏุงุช';
    } else {
        advancedContent.classList.add('hidden');
        toggleBtn.textContent = 'ุนุฑุถ ุงูุฅุนุฏุงุฏุงุช';
    }
}

function toggleHowItWorks() {
    const howItWorksContent = document.getElementById('howItWorksContent');
    const toggleBtn = document.getElementById('howItWorksToggle');
    
    if (howItWorksContent.classList.contains('hidden')) {
        howItWorksContent.classList.remove('hidden');
        toggleBtn.textContent = 'ุฅุฎูุงุก ุงูุดุฑุญ';
    } else {
        howItWorksContent.classList.add('hidden');
        toggleBtn.textContent = 'ุนุฑุถ ุงูุดุฑุญ';
    }
}

function toggleAIAssistant() {
    const aiContent = document.getElementById('aiContent');
    const toggleBtn = document.getElementById('aiToggle');
    
    if (aiContent.classList.contains('hidden')) {
        aiContent.classList.remove('hidden');
        toggleBtn.textContent = 'ุฅุฎูุงุก ุงููุตุงุฆุญ';
        updateAIRecommendations();
    } else {
        aiContent.classList.add('hidden');
        toggleBtn.textContent = 'ุนุฑุถ ุงููุตุงุฆุญ';
    }
}

function updateAIRecommendations() {
    if (resultsHistory.length === 0) return;
    
    const avgScore = resultsHistory.reduce((sum, result) => sum + parseInt(result.percentage), 0) / resultsHistory.length;
    const recentResults = resultsHistory.slice(0, 5);
    
    let performanceAnalysis = '';
    let recommendations = '';
    
    if (avgScore >= 80) {
        performanceAnalysis = `ุฃุฏุงุก ููุชุงุฒ! ูุชูุณุท ุงูุฏุฑุฌุงุช ${Math.round(avgScore)}%. ุงูุทูุงุจ ูุญูููู ูุชุงุฆุฌ ุฌูุฏุฉ.`;
        recommendations = 'ููููู ุฒูุงุฏุฉ ูุณุชูู ุตุนูุจุฉ ุงูุฃุณุฆูุฉ ูุชุญุฏู ุงูุทูุงุจ ุฃูุซุฑ.';
    } else if (avgScore >= 60) {
        performanceAnalysis = `ุฃุฏุงุก ุฌูุฏ. ูุชูุณุท ุงูุฏุฑุฌุงุช ${Math.round(avgScore)}%. ููุงู ูุฌุงู ููุชุญุณู.`;
        recommendations = 'ุฑุงุฌุน ุงูุฃุณุฆูุฉ ุงูุชู ูุฎุทุฆ ูููุง ุงูุทูุงุจ ูุซูุฑุงู ูุฑูุฒ ุนูููุง ูู ุงูุชุฏุฑูุณ.';
    } else {
        performanceAnalysis = `ูุญุชุงุฌ ุงูุฃุฏุงุก ููุชุญุณู. ูุชูุณุท ุงูุฏุฑุฌุงุช ${Math.round(avgScore)}%.`;
        recommendations = 'ูุฏ ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุทุฑููุฉ ุงูุชุฏุฑูุณ ุฃู ุชุจุณูุท ุงูุฃุณุฆูุฉ.';
    }
    
    document.getElementById('performanceAnalysis').innerHTML = performanceAnalysis;
    document.getElementById('customRecommendations').innerHTML = recommendations;
}

function generateQRCode() {
    const examName = document.getElementById('examName').value || 'ุงุฎุชุจุงุฑ ุฌุฏูุฏ';
    const questionCount = document.getElementById('questionCount').value;
    
    const qrData = {
        examName: examName,
        questionCount: questionCount,
        correctAnswers: correctAnswers,
        timestamp: new Date().toISOString()
    };
    
    const qrContent = `
        <div class="text-center p-6">
            <div class="w-48 h-48 bg-gray-200 mx-auto mb-4 flex items-center justify-center rounded-lg">
                <div class="text-6xl">๐ฑ</div>
            </div>
            <h3 class="text-lg font-semibold mb-2">ุฑูุฒ QR ููุงุฎุชุจุงุฑ</h3>
            <p class="text-sm text-gray-600 mb-4">${examName}</p>
            <p class="text-xs text-gray-500">ูููู ููุทูุงุจ ูุณุญ ูุฐุง ุงูุฑูุฒ ูููุตูู ููุนูููุงุช ุงูุงุฎุชุจุงุฑ</p>
        </div>
    `;
    
    showModal('ุฑูุฒ QR ููุงุฎุชุจุงุฑ', qrContent);
}

function printAnswerSheet() {
    const questionCount = parseInt(document.getElementById('questionCount').value) || 10;
    const optionsCount = parseInt(document.getElementById('optionsCount').value) || 4;
    const examName = document.getElementById('examName').value || 'ุงุฎุชุจุงุฑ';
    const options = optionsCount === 4 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E'];

    let printContent = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>ูููุฐุฌ ุฅุฌุงุจุฉ ุงูุทุงูุจ</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    margin: 20px;
                    direction: rtl;
                    background: white;
                    color: black;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 15px;
                }
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    gap: 20px;
                }
                .info-field {
                    flex: 1;
                }
                .info-field label {
                    display: block;
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                .info-field input {
                    width: 100%;
                    padding: 6px;
                    border: 1px solid #000;
                    border-radius: 4px;
                    font-size: 14px;
                }
                .questions-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 25px;
                }
                .question {
                    margin-bottom: 20px;
                    padding: 10px;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                }
                .question-header {
                    font-weight: bold;
                    margin-bottom: 10px;
                    font-size: 16px;
                }
                .options {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 15px;
                }
                .option {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .bubble {
                    width: 24px;
                    height: 24px;
                    border: 2px solid #000;
                    border-radius: 50%;
                    display: inline-block;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none !important; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="font-size: 24px; margin: 0;">${examName}</h1>
                <p>ูููุฐุฌ ุฅุฌุงุจุฉ ุงูุทุงูุจ</p>
            </div>

            <div class="info-row">
                <div class="info-field">
                    <label>ุงุณู ุงูุทุงูุจ:</label>
                    <input type="text" readonly>
                </div>
                <div class="info-field">
                    <label>ุฑูู ุงูุทุงูุจ:</label>
                    <input type="text" readonly>
                </div>
                <div class="info-field">
                    <label>ุงููุตู:</label>
                    <input type="text" readonly>
                </div>
                <div class="info-field">
                    <label>ุงูุชุงุฑูุฎ:</label>
                    <input type="text" readonly>
                </div>
            </div>

            <div class="questions-grid">
    `;

    for (let i = 1; i <= questionCount; i++) {
        printContent += `
            <div class="question">
                <div class="question-header">ุงูุณุคุงู ${i}:</div>
                <div class="options">
                    ${options.map(opt => `
                        <div class="option">
                            <span class="bubble"></span>
                            <span>${opt}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    printContent += `
            </div>

            <div class="no-print" style="text-align: center; margin-top: 30px;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                    ๐จ๏ธ ุทุจุงุนุฉ ุงููููุฐุฌ
                </button>
            </div>
    `;

    const printWindow = window.open('', '_blank', 'width=800,height=900');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();

    showNotification('ุชู ูุชุญ ูููุฐุฌ ุงูุฅุฌุงุจุฉ! ุงุถุบุท ุนูู ุฒุฑ "ุทุจุงุนุฉ" ูู ุงููุงูุฐุฉ ุงูุฌุฏูุฏุฉ.', 'success');
}

function importAnswers() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,.csv';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const answers = lines[0].split(',').map(a => a.trim());
                    
                    if (answers.length > 0 && answers.every(a => ['A', 'B', 'C', 'D', 'E'].includes(a))) {
                        correctAnswers = answers;
                        document.getElementById('questionCount').value = answers.length;
                        generateAnswerSheet();
                        
                        answers.forEach((answer, index) => {
                            const select = document.getElementById(`answer${index + 1}`);
                            if (select) select.value = answer;
                        });
                        
                        showNotification('ุชู ุงุณุชูุฑุงุฏ ุงูุฅุฌุงุจุงุช ุจูุฌุงุญ!', 'success');
                    } else {
                        showNotification('ุชูุณูู ุงูููู ุบูุฑ ุตุญูุญ!', 'error');
                    }
                } catch (error) {
                    showNotification('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู!', 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function backupData() {
    const backupData = {
        resultsHistory: resultsHistory,
        settings: {
            passingGrade: document.getElementById('passingGrade').value,
            gradingSystem: document.getElementById('gradingSystem').value,
            cameraResolution: document.getElementById('cameraResolution').value,
            imageQuality: document.getElementById('imageQuality').value
        },
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ูุณุฎุฉ_ุงุญุชูุงุทูุฉ_${new Date().toLocaleDateString('ar-SA')}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!', 'success');
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">${title}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">โ</button>
            </div>
            ${content}
        </div>
    `;
    document.body.appendChild(modal);
}

function showCameraSection() {
    document.getElementById('cameraSection').classList.remove('hidden');
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('cameraTabBtn').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    document.getElementById('uploadTabBtn').className = 'flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
}

function showUploadSection() {
    document.getElementById('cameraSection').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
    document.getElementById('cameraTabBtn').className = 'flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    document.getElementById('uploadTabBtn').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    
    if (stream) {
        stopCamera();
    }
}

function downloadStudentsTemplate() {
    const wb = XLSX.utils.book_new();
    
    const data = [
        ['ุงุณู ุงูุทุงูุจ', 'ุงููุตู'],
        ['ูุงุทูุฉ ุนูู ูุญูุฏ ุงูุฒูุฑุงูู', '1ุฃ'],
        ['ูุญูุฏ ุณุงูู ุฃุญูุฏ ุงููุญุทุงูู', '2ุจ'],
        ['ููุฑุง ุฃุญูุฏ ุนุจุฏุงููู ุงูุนุชูุจู', '2ุจ'],
        ['ุฎุงูุฏ ููุณู ุณุนุฏ ุงูุบุงูุฏู', '3ุฌ'],
        ['ุณุงุฑุฉ ุฃุญูุฏ ูุญูุฏ ุงูุญุฑุจู', '1ุฃ'],
        ['ุนุจุฏุงููู ุณุนุฏ ุนูู ุงููุทูุฑู', '2ุจ'],
        ['ูุฑูู ุฎุงูุฏ ุฃุญูุฏ ุงูุฏูุณุฑู', '3ุฌ']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    ws['A1'].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFF00" } } };
    ws['B1'].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFF00" } } };
    
    ws['!cols'] = [
        { wch: 30 },
        { wch: 10 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'ูุงุฆูุฉ ุงูุทูุงุจ');
    XLSX.writeFile(wb, 'ูููุฐุฌ_ูุงุฆูุฉ_ุงูุทูุงุจ.xlsx');
    
    showNotification('ุชู ุชุญููู ูููุฐุฌ Excel! ุงููุฃู ุจุจูุงูุงุช ุงูุทูุงุจ ุซู ุงุฑูุนู.', 'success');
}

function parseStudentsFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            let jsonData;
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                const csvText = e.target.result;
                const lines = csvText.split('\n').filter(line => line.trim());
                jsonData = lines.map(line => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                });
            } else {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            }
            
            if (jsonData.length < 2) {
                showNotification('ุงูููู ูุฌุจ ุฃู ูุญุชูู ุนูู ุจูุงูุงุช ุงูุทูุงุจ!', 'error');
                return;
            }
            
            const students = [];
            const headers = jsonData[0].map(h => String(h).trim());
            
            const nameIndex = headers.findIndex(h => 
                h.includes('ุงุณู') || h.includes('ุงูุงุณู') || 
                h.toLowerCase().includes('name') || 
                h.toLowerCase().includes('student')
            );
            
            const classIndex = headers.findIndex(h => 
                h.includes('ูุตู') || h.includes('ุงููุตู') || 
                h.includes('ุตู') || h.includes('ุงูุตู') ||
                h.toLowerCase().includes('class') || 
                h.toLowerCase().includes('grade')
            );
            
            if (nameIndex === -1) {
                showNotification('ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏ ุงูุงุณู! ุชุฃูุฏ ูู ูุฌูุฏ ุนููุฏ ูุญุชูู ุนูู "ุงุณู ุงูุทุงูุจ" ุฃู "Name"', 'error');
                return;
            }
            
            if (classIndex === -1) {
                showNotification('ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏ ุงููุตู! ุชุฃูุฏ ูู ูุฌูุฏ ุนููุฏ ูุญุชูู ุนูู "ุงููุตู" ุฃู "Class"', 'error');
                return;
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > Math.max(nameIndex, classIndex)) {
                    const name = String(row[nameIndex] || '').trim();
                    const className = String(row[classIndex] || '').trim();
                    
                    if (name && className) {
                        students.push({
                            id: Date.now() + i + Math.random() * 1000,
                            name: name,
                            studentId: `ST${String(Date.now() + i).slice(-6)}`,
                            class: className,
                            corrected: false,
                            result: null,
                            timestamp: null
                        });
                    }
                }
            }
            
            if (students.length === 0) {
                showNotification('ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุตุญูุญุฉ ูู ุงูููู! ุชุฃูุฏ ูู ููุก ุงูุงุณู ูุงููุตู.', 'error');
                return;
            }
            
            const existingNames = studentsList.map(s => s.name);
            const newStudents = students.filter(s => !existingNames.includes(s.name));
            
            if (newStudents.length === 0) {
                showNotification('ุฌููุน ุงูุทูุงุจ ููุฌูุฏูู ุจุงููุนู ูู ุงููุงุฆูุฉ!', 'info');
                return;
            }
            
            studentsList = [...studentsList, ...newStudents];
            localStorage.setItem('studentsList', JSON.stringify(studentsList));
            displayStudentsList();
            
            showNotification(`ุชู ุงุณุชูุฑุงุฏ ${newStudents.length} ุทุงูุจ ุฌุฏูุฏ ุจูุฌุงุญ! (ุชู ุชุฌุงูู ${students.length - newStudents.length} ุทุงูุจ ููุฑุฑ)`, 'success');
            
        } catch (error) {
            console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู:', error);
            showNotification('ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู! ุชุฃูุฏ ูู ุฃู ุงูููู ุตุญูุญ ูุบูุฑ ูุญูู ุจูููุฉ ูุฑูุฑ.', 'error');
        }
    };
    
    if (file.name.toLowerCase().endsWith('.csv')) {
        reader.readAsText(file, 'UTF-8');
    } else {
        reader.readAsArrayBuffer(file);
    }
}

function displayStudentsList() {
    const studentsListSection = document.getElementById('studentsListSection');
    const studentsList_div = document.getElementById('studentsList');
    
    if (studentsList.length === 0) {
        studentsListSection.classList.add('hidden');
        return;
    }
    
    studentsListSection.classList.remove('hidden');
    updateStudentsStats();
    updateClassFilter();
    updateStudentNameDropdown();
    filterStudentsList();
}

function updateStudentNameDropdown() {
    const studentNameSelect = document.getElementById('studentName');
    const currentValue = studentNameSelect.value;
    
    studentNameSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงุณู ุงูุทุงูุจ</option>';
    
    const uncorrectedStudents = studentsList.filter(s => !s.corrected);
    uncorrectedStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.name;
        option.textContent = student.name;
        studentNameSelect.appendChild(option);
    });
    
    if (currentValue && uncorrectedStudents.find(s => s.name === currentValue)) {
        studentNameSelect.value = currentValue;
        updateStudentClass();
    }
}

function updateStudentsStats() {
    const totalStudents = studentsList.length;
    const correctedStudents = studentsList.filter(s => s.corrected).length;
    const pendingStudents = totalStudents - correctedStudents;
    const uniqueClasses = [...new Set(studentsList.map(s => s.class))].length;
    
    document.getElementById('totalStudentsCount').textContent = totalStudents;
    document.getElementById('correctedCount').textContent = correctedStudents;
    document.getElementById('pendingCount').textContent = pendingStudents;
    document.getElementById('uniqueClassesCount').textContent = uniqueClasses;
}

function updateClassFilter() {
    const filterClass = document.getElementById('filterClass');
    const uniqueClasses = [...new Set(studentsList.map(s => s.class))];
    
    filterClass.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' +
        uniqueClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('');
}

function filterStudentsList() {
    const searchTerm = document.getElementById('searchStudentName').value.toLowerCase();
    const classFilter = document.getElementById('filterClass').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    let filteredStudents = [...studentsList];
    
    if (searchTerm) {
        filteredStudents = filteredStudents.filter(student => 
            student.name.toLowerCase().includes(searchTerm)
        );
    }
    
    if (classFilter) {
        filteredStudents = filteredStudents.filter(student => 
            student.class === classFilter
        );
    }
    
    if (statusFilter) {
        filteredStudents = filteredStudents.filter(student => 
            statusFilter === 'corrected' ? student.corrected : !student.corrected
        );
    }
    
    displayFilteredStudents(filteredStudents);
}

function displayFilteredStudents(students) {
    const studentsList_div = document.getElementById('studentsList');
    
    if (students.length === 0) {
        studentsList_div.innerHTML = '<div class="text-center text-gray-500 py-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุทุงุจู ุงูุจุญุซ</div>';
        return;
    }
    
    studentsList_div.innerHTML = students.map(student => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${student.corrected ? 'border-green-300 bg-green-50' : 'border-gray-200'}">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center ${student.corrected ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                    ${student.corrected ? 'โ' : student.name.charAt(0)}
                </div>
                <div>
                    <div class="font-semibold text-gray-800">${student.name}</div>
                    <div class="text-sm text-gray-600">${student.studentId} | ${student.class}</div>
                    ${student.corrected ? `<div class="text-xs text-green-600">ุชู ุงูุชุตุญูุญ: ${student.result?.percentage || '-'}</div>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                ${!student.corrected ? `
                    <button onclick="selectStudent(${student.id})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        ุงุฎุชูุงุฑ
                    </button>
                ` : `
                    <button onclick="viewStudentResult(${student.id})" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        ุนุฑุถ ุงููุชูุฌุฉ
                    </button>
                `}
                <button onclick="editStudent(${student.id})" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                    ุชุนุฏูู
                </button>
                <button onclick="deleteStudent(${student.id})" 
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                    ุญุฐู
                </button>
            </div>
        </div>
    `).join('');
}

function selectStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    currentStudent = student;
    
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentClass').value = student.class;
    
    document.getElementById('currentStudentName').textContent = student.name;
    document.getElementById('currentStudentClass').textContent = student.class;
    document.getElementById('currentStudentSection').classList.remove('hidden');
    
    showNotification(`ุชู ุงุฎุชูุงุฑ ุงูุทุงูุจ: ${student.name}`, 'success');
}

function selectDifferentStudent() {
    document.getElementById('currentStudentSection').classList.add('hidden');
    currentStudent = null;
    document.getElementById('studentName').value = '';
    document.getElementById('studentClass').value = '';
}

function editStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    const newName = prompt('ุงุณู ุงูุทุงูุจ ุงูุฌุฏูุฏ:', student.name);
    if (newName && newName.trim()) {
        student.name = newName.trim();
    }
    
    const newStudentId = prompt('ุฑูู ุงูุทุงูุจ ุงูุฌุฏูุฏ:', student.studentId);
    if (newStudentId && newStudentId.trim()) {
        student.studentId = newStudentId.trim();
    }
    
    const newClass = prompt('ุงูุตู ุงูุฌุฏูุฏ:', student.class);
    if (newClass && newClass.trim()) {
        student.class = newClass.trim();
    }
    
    localStorage.setItem('studentsList', JSON.stringify(studentsList));
    displayStudentsList();
    showNotification('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุทุงูุจ!', 'success');
}

function deleteStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุทุงูุจ: ${student.name}ุ`)) {
        studentsList = studentsList.filter(s => s.id !== studentId);
        localStorage.setItem('studentsList', JSON.stringify(studentsList));
        displayStudentsList();
        
        if (currentStudent && currentStudent.id === studentId) {
            selectDifferentStudent();
        }
        
        showNotification('ุชู ุญุฐู ุงูุทุงูุจ!', 'success');
    }
}

function clearStudentsList() {
    if (studentsList.length === 0) {
        showNotification('ุงููุงุฆูุฉ ูุงุฑุบุฉ ุจุงููุนู!', 'info');
        return;
    }
    
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุทูุงุจุ')) {
        studentsList = [];
        localStorage.removeItem('studentsList');
        displayStudentsList();
        selectDifferentStudent();
        showNotification('ุชู ูุณุญ ูุงุฆูุฉ ุงูุทูุงุจ!', 'success');
    }
}

function viewStudentResult(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student || !student.result) return;
    
    const result = student.result;
    const modalContent = `
        <div class="text-center">
            <div class="mb-4">
                <h4 class="text-lg font-semibold">${student.name}</h4>
                <p class="text-sm text-gray-600">${student.studentId} | ${student.class}</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-green-100 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${result.correctCount}</div>
                    <div class="text-sm text-green-800">ุฅุฌุงุจุงุช ุตุญูุญุฉ</div>
                </div>
                <div class="bg-red-100 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${result.wrongCount}</div>
                    <div class="text-sm text-red-800">ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ</div>
                </div>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg">
                <div class="text-3xl font-bold text-blue-600">${result.percentage}</div>
                <div class="text-sm text-blue-800">${result.grade}</div>
            </div>
            <div class="mt-4 text-xs text-gray-500">
                ุชู ุงูุชุตุญูุญ: ${student.timestamp}
            </div>
        </div>
    `;
    
    showModal(`ูุชูุฌุฉ ${student.name}`, modalContent);
}

function toggleMultipleCorrection() {
    const multipleCorrectionSection = document.getElementById('multipleCorrectionSection');
    
    if (multipleCorrectionSection.classList.contains('hidden')) {
        if (studentsList.filter(s => !s.corrected).length === 0) {
            showNotification('ูุง ุชูุฌุฏ ุฃูุฑุงู ูู ุงูุชุธุงุฑ ุงูุชุตุญูุญ!', 'error');
            return;
        }
        multipleCorrectionSection.classList.remove('hidden');
        setupMultipleCorrection();
    } else {
        multipleCorrectionSection.classList.add('hidden');
        resetMultipleCorrectionUI();
    }
}

function setupMultipleCorrection() {
    multiCorrectionQueue = studentsList.filter(s => !s.corrected);
    currentMultiIndex = 0;
    multiCorrectionResults = [];
    
    updateMultiCorrectionProgress();
    
    document.getElementById('progressText').textContent = `0 ูู ${multiCorrectionQueue.length}`;
    document.getElementById('progressBar').style.width = '0%';
}

function startMultipleCorrection() {
    if (correctAnswers.length === 0) {
        showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุฃููุงู!', 'error');
        return;
    }
    
    isMultipleCorrectionMode = true;
    currentMultiIndex = 0;
    
    document.getElementById('startMultiBtn').disabled = true;
    document.getElementById('skipStudentBtn').disabled = false;
    document.getElementById('pauseMultiBtn').disabled = false;
    document.getElementById('stopMultiBtn').disabled = false;
    
    updateMultiCorrectionButtons();
    showCurrentMultiStudent();
    
    showNotification('ุชู ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ! ุตููุฑ ูุฑูุฉ ุงูุทุงูุจ ุงูุฃูู.', 'success');
}

function showCurrentMultiStudent() {
    if (currentMultiIndex >= multiCorrectionQueue.length) {
        completeMultipleCorrection();
        return;
    }
    
    const student = multiCorrectionQueue[currentMultiIndex];
    
    document.getElementById('multiStudentName').textContent = student.name;
    document.getElementById('multiStudentClass').textContent = student.class;
    document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
    document.getElementById('currentMultiStudent').classList.remove('hidden');
    
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentClass').value = student.class;
    
    updateMultiCorrectionProgress();
}

function updateMultiCorrectionProgress() {
    const progress = (currentMultiIndex / multiCorrectionQueue.length) * 100;
    document.getElementById('progressText').textContent = `${currentMultiIndex} ูู ${multiCorrectionQueue.length}`;
    document.getElementById('progressBar').style.width = progress + '%';
}

function skipCurrentStudent() {
    if (currentMultiIndex < multiCorrectionQueue.length) {
        const student = multiCorrectionQueue[currentMultiIndex];
        multiCorrectionResults.push({
            student: student,
            status: 'skipped',
            result: null
        });
        
        currentMultiIndex++;
        showCurrentMultiStudent();
        showNotification(`ุชู ุชุฎุทู ${student.name}. ุงูุชูู ููุทุงูุจ ุงูุชุงูู.`, 'info');
    }
}

function pauseMultipleCorrection() {
    isMultipleCorrectionMode = false;
    
    document.getElementById('startMultiBtn').disabled = false;
    document.getElementById('skipStudentBtn').disabled = true;
    document.getElementById('pauseMultiBtn').disabled = true;
    document.getElementById('stopMultiBtn').disabled = true;
    
    updateMultiCorrectionButtons();
    
    showNotification('ุชู ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ ูุคูุชุงู. ููููู ุงููุชุงุจุนุฉ ูุงุญูุงู.', 'info');
}

function stopMultipleCorrection() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏุ ุณูุชู ููุฏุงู ุงูุชูุฏู ุงูุญุงูู.')) {
        resetMultipleCorrection();
        showNotification('ุชู ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ.', 'info');
    }
}

function resetMultipleCorrection() {
    isMultipleCorrectionMode = false;
    multiCorrectionQueue = [];
    currentMultiIndex = 0;
    multiCorrectionResults = [];
    
    resetMultipleCorrectionUI();
    document.getElementById('multipleCorrectionSection').classList.add('hidden');
}

function resetMultipleCorrectionUI() {
    document.getElementById('startMultiBtn').disabled = false;
    document.getElementById('skipStudentBtn').disabled = true;
    document.getElementById('pauseMultiBtn').disabled = true;
    document.getElementById('stopMultiBtn').disabled = true;
    document.getElementById('currentMultiStudent').classList.add('hidden');
    document.getElementById('multiCorrectionReport').classList.add('hidden');
    
    updateMultiCorrectionButtons();
}

function updateMultiCorrectionButtons() {
    const buttons = [
        { id: 'startMultiBtn', enabled: !document.getElementById('startMultiBtn').disabled },
        { id: 'skipStudentBtn', enabled: !document.getElementById('skipStudentBtn').disabled },
        { id: 'pauseMultiBtn', enabled: !document.getElementById('pauseMultiBtn').disabled },
        { id: 'stopMultiBtn', enabled: !document.getElementById('stopMultiBtn').disabled }
    ];
    
    buttons.forEach(btn => {
        const element = document.getElementById(btn.id);
        if (btn.enabled) {
            element.className = element.className.replace('disabled:bg-gray-400 disabled:cursor-not-allowed', '');
        } else {
            if (!element.className.includes('disabled:bg-gray-400')) {
                element.className += ' disabled:bg-gray-400 disabled:cursor-not-allowed';
            }
        }
    });
}

// ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
function completeMultipleCorrection() {
    isMultipleCorrectionMode = false;
    generateMultiCorrectionReport();
    
    document.getElementById('startMultiBtn').disabled = false;
    document.getElementById('skipStudentBtn').disabled = true;
    document.getElementById('pauseMultiBtn').disabled = true;
    document.getElementById('stopMultiBtn').disabled = true;
    document.getElementById('currentMultiStudent').classList.add('hidden');
    
    showNotification('ุชู ุฅููุงู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ!', 'success');
}

// ุฅุนุงุฏุฉ ุชุนููู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
function resetMultiCorrection() {
    document.getElementById('multiCorrectionReport').classList.add('hidden');
    setupMultipleCorrection();
    showNotification('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุชุตุญูุญ ุงููุชุนุฏุฏ.', 'info');
}

function generateMultiCorrectionReport() {
    const reportContent = document.getElementById('multiReportContent');
    const totalStudents = multiCorrectionResults.length;
    const correctedStudents = multiCorrectionResults.filter(r => r.status === 'completed').length;
    const skippedStudents = multiCorrectionResults.filter(r => r.status === 'skipped').length;
    
    let avgScore = 0;
    const completedResults = multiCorrectionResults.filter(r => r.status === 'completed' && r.result);
    if (completedResults.length > 0) {
        avgScore = Math.round(completedResults.reduce((sum, r) => sum + parseInt(r.result.percentage), 0) / completedResults.length);
    }
    
    reportContent.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-100 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-600">${totalStudents}</div>
                <div class="text-xs text-blue-800">ุฅุฌูุงูู ุงูุทูุงุจ</div>
            </div>
            <div class="bg-green-100 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-600">${correctedStudents}</div>
                <div class="text-xs text-green-800">ุชู ุชุตุญูุญูุง</div>
            </div>
            <div class="bg-yellow-100 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-yellow-600">${skippedStudents}</div>
                <div class="text-xs text-yellow-800">ุชู ุชุฎุทููุง</div>
            </div>
            <div class="bg-purple-100 p-3 rounded-lg text-center">
                <div class="text-2xl font-bold text-purple-600">${avgScore}%</div>
                <div class="text-xs text-purple-800">ูุชูุณุท ุงูุฏุฑุฌุงุช</div>
            </div>
        </div>
        
        <div class="space-y-2 max-h-64 overflow-y-auto">
            ${multiCorrectionResults.map(result => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${result.status === 'completed' ? 'border-green-300' : 'border-yellow-300'}">
                    <div>
                        <div class="font-semibold">${result.student.name}</div>
                        <div class="text-sm text-gray-600">${result.student.studentId} | ${result.student.class}</div>
                    </div>
                    <div class="text-right">
                        ${result.status === 'completed' ? 
                            `<div class="text-lg font-bold text-green-600">${result.result.percentage}</div>
                             <div class="text-sm text-green-800">${result.result.grade}</div>` :
                            `<div class="text-sm text-yellow-600">ุชู ุงูุชุฎุทู</div>`
                        }
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('multiCorrectionReport').classList.remove('hidden');
}

function exportMultiReport() {
    const reportData = multiCorrectionResults.map(result => ({
        'ุงุณู ุงูุทุงูุจ': result.student.name,
        'ุฑูู ุงูุทุงูุจ': result.student.studentId,
        'ุงูุตู': result.student.class,
        'ุงูุญุงูุฉ': result.status === 'completed' ? 'ุชู ุงูุชุตุญูุญ' : 'ุชู ุงูุชุฎุทู',
        'ุงูุฏุฑุฌุฉ': result.result ? result.result.percentage : '-',
        'ุงูุชูุฏูุฑ': result.result ? result.result.grade : '-'
    }));
    
    const csvContent = 'ุงุณู ุงูุทุงูุจ,ุฑูู ุงูุทุงูุจ,ุงูุตู,ุงูุญุงูุฉ,ุงูุฏุฑุฌุฉ,ุงูุชูุฏูุฑ\n' +
        reportData.map(row => Object.values(row).map(val => `"${val}"`).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ุชูุฑูุฑ_ุงูุชุตุญูุญ_ุงููุชุนุฏุฏ_${new Date().toLocaleDateString('ar-SA')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('ุชู ุชุตุฏูุฑ ุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ!', 'success');
}

async function processImageWithAI(imageSrc) {
    showNotification('ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ ุจุงุณุชุฎุฏุงู OpenCV...', 'info');
    const res = await fetch(imageSrc);
    const blob = await res.blob();
    const formData = new FormData();
    formData.append('image', blob, 'answer_sheet.jpg');
    // ุฅุถุงูุฉ ุนุฏุฏ ุงูุฃุณุฆูุฉ ูุงูุฎูุงุฑุงุช ูู ุงููุงุฌูุฉ
    formData.append('num_questions', document.getElementById('questionCount').value || 10);
    formData.append('options_per_q', document.getElementById('optionsCount').value || 4);

    const response = await fetch('https://examm.onrender.com/api/correct', {
        method: 'POST',
        body: formData
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'ูุดู ูู ุงูุชุญููู');
    return data.answers; // ["A", "B", "ูุฑุงุบ", ...]
}

        // === ูุนุงูุฌุฉ ุงููุชุงุฆุฌ ===
        function processAnswers() {
            if (correctAnswers.length === 0) {
                showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุฃููุงู!', 'error');
                return;
            }
            startTime = Date.now();
            const capturedImage = document.getElementById('capturedImage');
            processImageWithAI(capturedImage.src)
                .then(results => {
                    studentAnswers = results;
                    showAnswerVerification();
                })
                .catch(err => {
                    showNotification('ูุดู ูู ุชุญููู ุงูุตูุฑุฉ: ' + err.message, 'error');
                });
        }

        function processUploadedImage() {
            if (correctAnswers.length === 0) {
                showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุฃููุงู!', 'error');
                return;
            }
            startTime = Date.now();
            const uploadedImage = document.getElementById('imagePreview');
            processImageWithAI(uploadedImage.src)
                .then(results => {
                    studentAnswers = results;
                    showAnswerVerification();
                    document.getElementById('capturedSection').classList.add('hidden');
                })
                .catch(err => {
                    showNotification('ูุดู ูู ุชุญููู ุงูุตูุฑุฉ: ' + err.message, 'error');
                });
        }

        // === ุชููุฆุฉ ุนูุฏ ุงูุชุญููู ===
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('examDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('studentsFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) parseStudentsFile(file);
            });
            document.getElementById('imageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('imagePreview').src = ev.target.result;
                        document.getElementById('imagePreviewContainer').classList.remove('hidden');
                        document.getElementById('processUploadBtn').disabled = false;
                        showNotification('ุชู ุชุญููู ุงูุตูุฑุฉ ุจูุฌุงุญ!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
		// ุชูุธูู ุงูููุงุฑุฏ
function cleanupResources() {
    if (stream) {
        stopCamera();
    }
    
    const capturedImage = document.getElementById('capturedImage');
    const imagePreview = document.getElementById('imagePreview');
    
    if (capturedImage.src.startsWith('data:')) {
        capturedImage.src = '';
    }
    
    if (imagePreview.src.startsWith('data:')) {
        imagePreview.src = '';
    }
}

// ุชุญุณูู ุงูุตูุฑุฉ ูููุนุงูุฌุฉ
function optimizeImageForProcessing(imageElement) {
    showNotification('ุฌุงุฑู ุชุญุณูู ุฌูุฏุฉ ุงูุตูุฑุฉ...', 'info');
    
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve(imageElement);
        }, 1000);
    });
}
    </script>
</body>
</html>